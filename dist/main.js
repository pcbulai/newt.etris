(()=>{"use strict";const t={orange:"#FF9D00",red:"#FF0000",green:"#29BB00",yellow:"#FFFB00",purple:"#9B0089",lightGrey:"#fcfcfc",grey:"#f0f0f0",black:"#000"};var e;!function(t){t[t.TICK=0]="TICK",t[t.MOVE_DOWN=1]="MOVE_DOWN",t[t.MOVE_RIGHT=2]="MOVE_RIGHT",t[t.MOVE_LEFT=3]="MOVE_LEFT",t[t.ROTATE_RIGHT=4]="ROTATE_RIGHT",t[t.ROTATE_LEFT=5]="ROTATE_LEFT",t[t.PLAY_PAUSE=6]="PLAY_PAUSE",t[t.BOOSTER_ENGAGED=7]="BOOSTER_ENGAGED"}(e||(e={}));const n=[{matrix:[["1",null,null],["1",null,null],["1","1",null]],color:"orange"},{matrix:[["1","1","1","1"]],color:"red"},{matrix:[["1",null,null],["1","1",null],[null,"1",null]],color:"green"},{matrix:[["1","1"],["1","1"]],color:"yellow"},{matrix:[["1","1","1"],[null,"1",null]],color:"purple"}];function i(t=1){const e=new Uint32Array(1);return window.crypto.getRandomValues(e),e[0]%t}function r(t,e){return new Array(e).fill(null).map((()=>new Array(t).fill(null)))}function o(t){let e=t[0].length,n=0,i=t.length,r=0;return t.forEach(((t,o)=>{t.forEach(((t,s)=>{t&&(s<e?e=s:s>n&&(n=s),o<i?i=o:o>r&&(r=o))}))})),[[e,i],[n,r]]}function s(t,...e){return e.reduce(((t,e)=>e(t)),t)}function a(t){return t[0].map(((e,n)=>t.map((t=>t[n])).reverse()))}function c(t){const[[e,n],[i,r]]=o(t.matrix);return Object.assign(Object.assign({},t),{x:t.x+e,y:t.y+n,matrix:t.matrix.slice(n,r+1).map((t=>t.slice(e,i+1)))})}function l({activeTetromino:t,matrix:e,stageWidth:n,stageHeight:i}){if(null==t)return!1;const r=c(t),o=r.x,s=r.matrix[0].length,a=o+s,l=r.y,u=r.matrix.length;return o<0||a>n||l+u>i||r.matrix.some(((t,n)=>t.some(((t,i)=>{var r;return t&&(null===(r=e[l+n])||void 0===r?void 0:r[o+i])}))))}class u{constructor(t,e=10){this.pool=[],this.createFn=t;for(let t=0;t<e;t++)this.pool.push(this.createFn())}acquire(){return this.pool.length>0?this.pool.pop():this.createFn()}release(t){this.pool.push(t)}}function h(e,c){const{activeTetromino:l,matrix:u,stageWidth:h,stageHeight:d}=e,m=(f=n)[i(f.length)];var f;const g=function(t){return s(t,...new Array(Math.floor(i(3))).fill(a))}(m.matrix),[[v],[T,O]]=o(g),b=T-v+1,p=c.acquire();return p.x=Math.floor(h/2-b/2)-v,p.y=-O-1,p.fill=t[m.color],p.matrix=g,l&&c.release(l),Object.assign(Object.assign({},e),{activeTetromino:p,matrix:null==l?u:r(h,d).map(((t,e)=>t.map(((t,n)=>{var i,r;const o=n-l.x,s=e-l.y;return(null===(i=l.matrix[s])||void 0===i?void 0:i[o])?l.fill:null!==(r=u[e][n])&&void 0!==r?r:null}))))})}function d(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{x:t.activeTetromino.x+1})})}function m(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{x:t.activeTetromino.x-1})})}function f(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{matrix:a(t.activeTetromino.matrix)})})}function g(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{matrix:(e=t.activeTetromino.matrix,e[0].map(((t,n)=>e.map((t=>t[n])))).reverse())})});var e}const v={stageWidth:0,stageHeight:0,activeTetromino:null,matrix:[],score:0,booster:0,isGamePaused:!1,isGameOver:!1,clickCoords:null};class T{constructor(t,e){this.subscribers=new Set,this.state=Object.assign(Object.assign({},v),{stageWidth:t,stageHeight:e,matrix:r(t,e)}),this.tilePool=new u((()=>({x:0,y:0,matrix:[],fill:""})))}getState(){return this.state}dispatch(t){const n=((t=v,n,i)=>{switch(n.type){case e.TICK:case e.MOVE_DOWN:return null==t.activeTetromino?h(t,i):(()=>{const e=function(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{y:t.activeTetromino.y+1})})}(t);return l(e)?function({activeTetromino:t}){return c(t).y<0}(t)?function(t){return Object.assign(Object.assign({},t),{isGameOver:!0})}(t):h(t,i):function(t){const{matrix:e,stageWidth:n,stageHeight:i}=t,o=e.filter((t=>!t.every(Boolean))).reverse(),s=e.length-o.length,a=t.score+s;return Object.assign(Object.assign({},t),{score:a,matrix:r(n,i).map(((t,e)=>t.map(((t,n)=>{var i,r;return null!==(r=null===(i=o[e])||void 0===i?void 0:i[n])&&void 0!==r?r:null})))).reverse()})}(e)})();case e.MOVE_RIGHT:return l(s(t,d))?t:d(t);case e.MOVE_LEFT:return l(s(t,m))?t:m(t);case e.ROTATE_RIGHT:return l(s(t,f))?t:f(t);case e.ROTATE_LEFT:return l(s(t,g))?t:g(t);case e.PLAY_PAUSE:return Object.assign(Object.assign({},t),{isGamePaused:!t.isGamePaused});case e.BOOSTER_ENGAGED:const{matrix:o,booster:a}=t;if(!n.payload||0===a)return t;const{x:u,y:v}=n.payload,T=function(t,e,n){var i;const r=null===(i=t[n])||void 0===i?void 0:i[e];if(!r||!t)return t;const o=[[e,n]],s=new Set;for(;o.length>0;){const[e,n]=o.pop(),i=`${e},${n}`;s.has(i)||(s.add(i),t[n]&&t[n][e]===r&&(t[n][e]=null,o.push([e+1,n]),o.push([e-1,n]),o.push([e,n+1]),o.push([e,n-1])))}return function(t){const e=t[0].length,n=t.length;for(let i=0;i<e;i++)for(let e=n-1;e>=0;e--)if(null===t[e][i]){let n=e-1;for(;n>=0&&null===t[n][i];)n--;n>=0&&(t[e][i]=t[n][i],t[n][i]=null)}return t}(t)}(o,u,v);return Object.assign(Object.assign({},t),{matrix:T,booster:a-1});default:return t}})(this.state,t,this.tilePool);n!==this.state&&(this.state=n,this.subscribers.forEach((t=>t(this.state))))}subscribe(t){return this.subscribers.add(t),t(this.state),()=>this.subscribers.delete(t)}}function O({bufferWidth:n,bufferHeight:i,unit:r,store:o}){const s=document.querySelector(".game canvas");if(!s)return void console.error("Canvas element not found");s.width=n,s.height=i;const a=s.getContext("2d");if(!a)return void console.error("Failed to get 2D context");const c=function({ctx:e,bufferWidth:n,bufferHeight:i,unit:r}){const o=(n,i,o)=>{const s=n*r,a=i*r;e.fillStyle=o,e.fillRect(s,a,r,r),e.strokeStyle=t.black,e.lineWidth=1,e.strokeRect(s,a,r,r)};return s=>{var a;(()=>{e.fillStyle=t.lightGrey,e.fillRect(0,0,n,i),e.strokeStyle=t.grey,e.lineWidth=.5;for(let t=0;t<n;t+=r)for(let n=0;n<i;n+=r)e.strokeRect(t,n,r,r)})(),null===(a=s.activeTetromino)||void 0===a||a.matrix.forEach(((t,e)=>{t.forEach(((t,n)=>{if(t&&s.activeTetromino){const t=s.activeTetromino.x+n,i=s.activeTetromino.y+e;o(t,i,s.activeTetromino.fill)}}))})),s.matrix.forEach(((t,e)=>{t.forEach(((t,n)=>{t&&o(n,e,t)}))}))}}({ctx:a,bufferWidth:n,bufferHeight:i,unit:r}),l=document.querySelector(".game-score span"),u=document.querySelector(".game-booster span"),h=document.querySelector(".game-over"),d=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);return o.subscribe((t=>{const{score:e,booster:n,isGameOver:i}=t;l&&u&&h&&(l.textContent=`${e}`,u.textContent=`${n}`,i?(h.classList.add("visible"),h.classList.remove("hidden")):(h.classList.add("hidden"),h.classList.remove("visible")))})),function(t,n){const i=document.querySelector(".game-pause"),r=document.querySelector(".game-restart"),o=document.querySelector(".rotate-left"),s=document.querySelector(".rotate-right");null==t||t.addEventListener("click",(i=>{i.preventDefault();const r=t.getBoundingClientRect(),o=Math.floor((i.clientX-r.left)/32),s=Math.floor((i.clientY-r.top)/32);n.dispatch({type:e.BOOSTER_ENGAGED,payload:{x:o,y:s}})})),null==i||i.addEventListener("click",(t=>{t.preventDefault(),n.dispatch({type:e.PLAY_PAUSE})})),null==r||r.addEventListener("click",(t=>{t.preventDefault(),p({width:10,height:20,resolution:32})})),null==o||o.addEventListener("click",(t=>{n.dispatch({type:e.ROTATE_LEFT})})),null==s||s.addEventListener("click",(t=>{n.dispatch({type:e.ROTATE_RIGHT})}))}(a.canvas,o),d?function(t){let n=0,i=0,r=0,o=0;null===document||void 0===document||document.addEventListener("touchstart",(t=>{n=t.changedTouches[0].screenX,i=t.changedTouches[0].screenY})),null===document||void 0===document||document.addEventListener("touchend",(s=>{r=s.changedTouches[0].screenX,o=s.changedTouches[0].screenY,(()=>{const s=r-n,a=o-i;Math.abs(s)>Math.abs(a)?t.dispatch({type:s>0?e.MOVE_RIGHT:e.MOVE_LEFT}):a>0&&t.dispatch({type:e.MOVE_DOWN})})()}))}(o):function(t){document.addEventListener("keydown",(n=>{switch(n.key){case"s":t.dispatch({type:e.MOVE_DOWN});break;case"d":t.dispatch({type:e.MOVE_RIGHT});break;case"a":t.dispatch({type:e.MOVE_LEFT});break;case"ArrowRight":t.dispatch({type:e.ROTATE_RIGHT});break;case"ArrowLeft":t.dispatch({type:e.ROTATE_LEFT})}}))}(o),c}var b=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};function p({width:t,height:n,resolution:i}){const r=Math.max(4,Math.ceil(t)),o=Math.max(4,Math.ceil(n)),s=Math.ceil(i),a=r*s,c=o*s,l=new T(r,o),u=O({bufferWidth:a,bufferHeight:c,unit:s,store:l});u&&l.subscribe(u),function(t){b(this,void 0,void 0,(function*(){requestAnimationFrame((function n(){return b(this,void 0,void 0,(function*(){var i;t.getState().isGameOver||(t.getState().isGamePaused||t.dispatch({type:e.TICK}),yield(i=function({score:t}){return Math.floor(.25*t)+1.5}(t.getState()),new Promise((t=>setTimeout(t,1e3/i)))),requestAnimationFrame(n))}))}))}))}(l)}p({width:10,height:20,resolution:32})})();
//# sourceMappingURL=main.js.map