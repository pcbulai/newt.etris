(()=>{"use strict";const t={orange:"#FF9D00",red:"#FF0000",green:"#29BB00",yellow:"#FFFB00",purple:"#9B0089",lightGrey:"#fcfcfc",grey:"#f0f0f0",black:"#000"};var e,n;!function(t){t[t.TICK=0]="TICK",t[t.MOVE_DOWN=1]="MOVE_DOWN",t[t.MOVE_RIGHT=2]="MOVE_RIGHT",t[t.MOVE_LEFT=3]="MOVE_LEFT",t[t.ROTATE_RIGHT=4]="ROTATE_RIGHT",t[t.ROTATE_LEFT=5]="ROTATE_LEFT",t[t.PLAY_PAUSE=6]="PLAY_PAUSE",t[t.BOOSTER_ENGAGED=7]="BOOSTER_ENGAGED"}(e||(e={})),function(t){t.MOVE_DOWN="s",t.MOVE_RIGHT="d",t.MOVE_LEFT="a",t.ROTATE_RIGHT="ArrowRight",t.ROTATE_LEFT="ArrowLeft",t.PLAY_PAUSE=" "}(n||(n={}));const i=[{matrix:[["1",null,null],["1",null,null],["1","1",null]],color:"orange"},{matrix:[["1","1","1","1"]],color:"red"},{matrix:[["1",null,null],["1","1",null],[null,"1",null]],color:"green"},{matrix:[["1","1"],["1","1"]],color:"yellow"},{matrix:[["1","1","1"],[null,"1",null]],color:"purple"}];function r(t=1){const e=new Uint32Array(1);return window.crypto.getRandomValues(e),e[0]%t}function o(t,e){return new Array(e).fill(null).map((()=>new Array(t).fill(null)))}function s(t){let e=t[0].length,n=0,i=t.length,r=0;return t.forEach(((t,o)=>{t.forEach(((t,s)=>{t&&(s<e?e=s:s>n&&(n=s),o<i?i=o:o>r&&(r=o))}))})),[[e,i],[n,r]]}function a(t,...e){return e.reduce(((t,e)=>e(t)),t)}function c(t){return t[0].map(((e,n)=>t.map((t=>t[n])).reverse()))}function l(t){const[[e,n],[i,r]]=s(t.matrix);return Object.assign(Object.assign({},t),{x:t.x+e,y:t.y+n,matrix:t.matrix.slice(n,r+1).map((t=>t.slice(e,i+1)))})}function u({activeTetromino:t,matrix:e,stageWidth:n,stageHeight:i}){if(null==t)return!1;const r=l(t),o=r.x,s=r.matrix[0].length,a=o+s,c=r.y,u=r.matrix.length;return o<0||a>n||c+u>i||r.matrix.some(((t,n)=>t.some(((t,i)=>{var r;return t&&(null===(r=e[c+n])||void 0===r?void 0:r[o+i])}))))}class h{constructor(t,e=10){this.pool=[],this.createFn=t;for(let t=0;t<e;t++)this.pool.push(this.createFn())}acquire(){return this.pool.length>0?this.pool.pop():this.createFn()}release(t){this.pool.push(t)}}function d(e,n){const{activeTetromino:l,matrix:u,stageWidth:h,stageHeight:d}=e,m=(f=i)[r(f.length)];var f;const g=function(t){return a(t,...new Array(Math.floor(r(3))).fill(c))}(m.matrix),[[T],[v,O]]=s(g),E=v-T+1,b=n.acquire();return b.x=Math.floor(h/2-E/2)-T,b.y=-O-1,b.fill=t[m.color],b.matrix=g,l&&n.release(l),Object.assign(Object.assign({},e),{activeTetromino:b,matrix:null==l?u:o(h,d).map(((t,e)=>t.map(((t,n)=>{var i,r;const o=n-l.x,s=e-l.y;return(null===(i=l.matrix[s])||void 0===i?void 0:i[o])?l.fill:null!==(r=u[e][n])&&void 0!==r?r:null}))))})}function m(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{x:t.activeTetromino.x+1})})}function f(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{x:t.activeTetromino.x-1})})}function g(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{matrix:c(t.activeTetromino.matrix)})})}function T(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{matrix:(e=t.activeTetromino.matrix,e[0].map(((t,n)=>e.map((t=>t[n])))).reverse())})});var e}const v={stageWidth:0,stageHeight:0,activeTetromino:null,matrix:[],score:0,booster:0,isGamePaused:!1,isGameOver:!1,clickCoords:null};class O{constructor(t,e){this.subscribers=new Set,this.state=Object.assign(Object.assign({},v),{stageWidth:t,stageHeight:e,matrix:o(t,e)}),this.tilePool=new h((()=>({x:0,y:0,matrix:[],fill:""})))}getState(){return this.state}dispatch(t){const n=((t=v,n,i)=>{switch(n.type){case e.TICK:case e.MOVE_DOWN:return null==t.activeTetromino?d(t,i):(()=>{const e=function(t){return null==t.activeTetromino?t:Object.assign(Object.assign({},t),{activeTetromino:Object.assign(Object.assign({},t.activeTetromino),{y:t.activeTetromino.y+1})})}(t);return u(e)?function({activeTetromino:t}){return l(t).y<0}(t)?function(t){return Object.assign(Object.assign({},t),{isGameOver:!0})}(t):d(t,i):function(t){const{matrix:e,stageWidth:n,stageHeight:i}=t,r=e.filter((t=>!t.every(Boolean))).reverse(),s=e.length-r.length,a=t.score+s,c=Math.floor(a/10)>Math.floor(t.score/10)?++t.booster:t.booster;return Object.assign(Object.assign({},t),{score:a,booster:c,matrix:o(n,i).map(((t,e)=>t.map(((t,n)=>{var i,o;return null!==(o=null===(i=r[e])||void 0===i?void 0:i[n])&&void 0!==o?o:null})))).reverse()})}(e)})();case e.MOVE_RIGHT:return u(a(t,m))?t:m(t);case e.MOVE_LEFT:return u(a(t,f))?t:f(t);case e.ROTATE_RIGHT:return u(a(t,g))?t:g(t);case e.ROTATE_LEFT:return u(a(t,T))?t:T(t);case e.PLAY_PAUSE:return Object.assign(Object.assign({},t),{isGamePaused:!t.isGamePaused});case e.BOOSTER_ENGAGED:const{matrix:r,booster:s}=t;if(!n.payload||0===s)return t;const{x:c,y:h}=n.payload,v=function(t,e,n){var i;const r=null===(i=t[n])||void 0===i?void 0:i[e];if(console.log(t,e,n,r),!r||!t)return t;const o=[[e,n]],s=new Set;for(;o.length>0;){const[e,n]=o.pop(),i=`${e},${n}`;s.has(i)||(s.add(i),t[n]&&t[n][e]===r&&(t[n][e]=null,o.push([e+1,n]),o.push([e-1,n]),o.push([e,n+1]),o.push([e,n-1])))}return function(t){const e=t[0].length,n=t.length;for(let i=0;i<e;i++)for(let e=n-1;e>=0;e--)if(null===t[e][i]){let n=e-1;for(;n>=0&&null===t[n][i];)n--;n>=0&&(t[e][i]=t[n][i],t[n][i]=null)}return t}(t)}(r,c,h);return Object.assign(Object.assign({},t),{matrix:v,booster:s-1});default:return t}})(this.state,t,this.tilePool);n!==this.state&&(this.state=n,this.subscribers.forEach((t=>t(this.state))))}subscribe(t){return this.subscribers.add(t),t(this.state),()=>this.subscribers.delete(t)}}function E({bufferWidth:i,bufferHeight:r,unit:o,store:s}){const a=document.querySelector(".game canvas");if(!a)return void console.error("Canvas element not found");a.width=i,a.height=r;const c=a.getContext("2d");if(!c)return void console.error("Failed to get 2D context");const l=function({ctx:e,bufferWidth:n,bufferHeight:i,unit:r}){const o=(n,i,o)=>{const s=n*r,a=i*r;e.fillStyle=o,e.fillRect(s,a,r,r),e.strokeStyle=t.black,e.lineWidth=1,e.strokeRect(s,a,r,r)};return s=>{var a;(()=>{e.fillStyle=t.lightGrey,e.fillRect(0,0,n,i),e.strokeStyle=t.grey,e.lineWidth=.5;for(let t=0;t<n;t+=r)for(let n=0;n<i;n+=r)e.strokeRect(t,n,r,r)})(),null===(a=s.activeTetromino)||void 0===a||a.matrix.forEach(((t,e)=>{t.forEach(((t,n)=>{if(t&&s.activeTetromino){const t=s.activeTetromino.x+n,i=s.activeTetromino.y+e;o(t,i,s.activeTetromino.fill)}}))})),s.matrix.forEach(((t,e)=>{t.forEach(((t,n)=>{t&&o(n,e,t)}))}))}}({ctx:c,bufferWidth:i,bufferHeight:r,unit:o}),u=document.querySelector(".game-score span"),h=document.querySelector(".game-booster span"),d=document.querySelector(".game-over"),m=document.querySelector(".rotate-left"),f=document.querySelector(".rotate-right"),g=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);return s.subscribe((t=>{const{score:e,booster:n,isGameOver:i}=t;u&&h&&d&&(u.textContent=`${e}`,h.textContent=`${n}`,i?(d.classList.add("visible"),d.classList.remove("hidden")):(d.classList.add("hidden"),d.classList.remove("visible")))})),function(t,n){const i=document.querySelector(".game-pause"),r=document.querySelector(".game-restart");null==t||t.addEventListener("click",(i=>{const r=t.getBoundingClientRect(),o=Math.floor((i.clientX-r.left)/32),s=Math.floor((i.clientY-r.top)/32);console.log(o,s),n.dispatch({type:e.BOOSTER_ENGAGED,payload:{x:o,y:s}})})),null==i||i.addEventListener("click",(t=>{t.preventDefault(),n.dispatch({type:e.PLAY_PAUSE})})),null==r||r.addEventListener("click",(t=>{t.preventDefault(),p({width:10,height:20,resolution:32})}))}(c.canvas,s),g?(function(t){let n=0,i=0,r=0,o=0;const s=document.querySelector(".rotate-left"),a=document.querySelector(".rotate-right");null===document||void 0===document||document.addEventListener("touchstart",(t=>{n=t.changedTouches[0].screenX,i=t.changedTouches[0].screenY})),null===document||void 0===document||document.addEventListener("touchend",(s=>{r=s.changedTouches[0].screenX,o=s.changedTouches[0].screenY,(()=>{const s=r-n,a=o-i;Math.abs(s)>Math.abs(a)?t.dispatch({type:s>0?e.MOVE_RIGHT:e.MOVE_LEFT}):a>0&&t.dispatch({type:e.MOVE_DOWN})})()})),null==s||s.addEventListener("click",(()=>{t.dispatch({type:e.ROTATE_LEFT})})),null==a||a.addEventListener("click",(()=>{t.dispatch({type:e.ROTATE_RIGHT})}))}(s),null==m||m.classList.remove("hidden"),null==f||f.classList.remove("hidden")):function(t){document.addEventListener("keydown",(i=>{switch(i.key){case n.MOVE_DOWN:t.dispatch({type:e.MOVE_DOWN});break;case n.MOVE_RIGHT:t.dispatch({type:e.MOVE_RIGHT});break;case n.MOVE_LEFT:t.dispatch({type:e.MOVE_LEFT});break;case n.ROTATE_RIGHT:t.dispatch({type:e.ROTATE_RIGHT});break;case n.ROTATE_LEFT:t.dispatch({type:e.ROTATE_LEFT});break;case n.PLAY_PAUSE:t.dispatch({type:e.PLAY_PAUSE})}}))}(s),l}var b=function(t,e,n,i){return new(n||(n=Promise))((function(r,o){function s(t){try{c(i.next(t))}catch(t){o(t)}}function a(t){try{c(i.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,a)}c((i=i.apply(t,e||[])).next())}))};function p({width:t,height:n,resolution:i}){const r=Math.max(4,Math.ceil(t)),o=Math.max(4,Math.ceil(n)),s=Math.ceil(i),a=r*s,c=o*s,l=new O(r,o),u=E({bufferWidth:a,bufferHeight:c,unit:s,store:l});u&&l.subscribe(u),function(t){b(this,void 0,void 0,(function*(){requestAnimationFrame((function n(){return b(this,void 0,void 0,(function*(){var i;t.getState().isGameOver||(t.getState().isGamePaused||t.dispatch({type:e.TICK}),yield(i=function({score:t}){return Math.floor(.25*t)+1.5}(t.getState()),new Promise((t=>setTimeout(t,1e3/i)))),requestAnimationFrame(n))}))}))}))}(l)}p({width:10,height:20,resolution:32})})();
//# sourceMappingURL=main.js.map